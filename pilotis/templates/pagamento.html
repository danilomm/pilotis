{% extends "base.html" %}

{% block content %}
<style>
/* Abas de pagamento */
.payment-tabs {
    margin-bottom: 1.5rem;
}
.payment-tabs input[type="radio"] {
    display: none;
}
.tab-labels {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--pico-primary);
}
.tab-labels label {
    flex: 1;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    background: var(--pico-card-background-color);
    border: 1px solid var(--pico-muted-border-color);
    border-bottom: none;
    margin-bottom: -2px;
    font-weight: 500;
}
.tab-labels label:first-child {
    border-radius: 0.5rem 0 0 0;
}
.tab-labels label:last-child {
    border-radius: 0 0.5rem 0 0;
}
.tab-labels label.active {
    background: var(--pico-primary);
    color: var(--pico-primary-inverse);
    border-color: var(--pico-primary);
}
.tab-content {
    display: none;
    padding: 1.5rem;
    border: 1px solid var(--pico-muted-border-color);
    border-top: none;
    border-radius: 0 0 0.5rem 0.5rem;
}
.tab-content.active {
    display: block;
}
.metodo-icone {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 0.25rem;
}

/* Responsivo para celular */
@media (max-width: 600px) {
    .tab-labels label {
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
    }
    .metodo-icone {
        font-size: 1.2rem;
    }
    .tab-content {
        padding: 1rem;
    }
    /* QR Code menor no celular */
    .tab-content img[alt="QR Code PIX"] {
        max-width: 200px !important;
    }
    /* Campos do cartao empilhados */
    .tab-content form > div[style*="flex"] {
        flex-direction: column;
        gap: 0 !important;
    }
}
</style>

<article>
    <header>
        <h1>Pagamento - Filiacao {{ ano }}</h1>
    </header>

    <section>
        <h2>Resumo</h2>
        <table>
            <tr>
                <th>Nome</th>
                <td>{{ cadastrado.nome }}</td>
            </tr>
            <tr>
                <th>Email</th>
                <td>{{ cadastrado.email }}</td>
            </tr>
            <tr>
                <th>Categoria</th>
                <td>{{ cadastrado.categoria }}</td>
            </tr>
            <tr>
                <th>Valor</th>
                <td><strong>{{ valor_formatado }}</strong></td>
            </tr>
        </table>
    </section>

    <section>
        <h2>Escolha a forma de pagamento</h2>

        {% if erro_pagbank %}
        <aside style="background-color: #fee; border-left-color: #c00;">
            <p><strong>Erro ao gerar cobranca</strong></p>
            <p>{{ erro_pagbank }}</p>
            <p>Entre em contato com a tesouraria: <a href="mailto:tesouraria@docomomobrasil.com">tesouraria@docomomobrasil.com</a></p>
        </aside>
        {% else %}

        <div class="payment-tabs">
            <!-- Labels das abas -->
            <div class="tab-labels">
                <label class="active" onclick="showTab('pix')">
                    <span class="metodo-icone">âš¡</span>
                    PIX
                </label>
                <label onclick="showTab('boleto')">
                    <span class="metodo-icone">ðŸ“„</span>
                    Boleto
                </label>
                <label onclick="showTab('cartao')">
                    <span class="metodo-icone">ðŸ’³</span>
                    Cartao
                </label>
            </div>

            <!-- Conteudo PIX -->
            <div id="tab-pix" class="tab-content active">
                {% if pix %}
                <p>Escaneie o QR Code abaixo ou copie o codigo PIX:</p>

                {% if pix.qr_code_link %}
                <div style="text-align: center; margin: 2rem 0;">
                    <img src="{{ pix.qr_code_link }}" alt="QR Code PIX" style="max-width: 250px;">
                </div>
                {% endif %}

                {% if pix.qr_code %}
                <div>
                    <label for="pix-code">Codigo PIX (Copia e Cola):</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="pix-code" value="{{ pix.qr_code }}" readonly style="flex: 1; font-size: 0.85rem;">
                        <button type="button" onclick="copiarPix()" class="secondary" style="width: auto;">Copiar</button>
                    </div>
                </div>
                {% endif %}

                <p><small>Validade: {{ pix.expiration_date[:10] if pix.expiration_date else '3 dias' }}</small></p>

                <aside>
                    <p><strong>Apos o pagamento</strong></p>
                    <p>O sistema sera notificado automaticamente. Voce recebera um email de confirmacao em ate 5 minutos apos a compensacao do PIX.</p>
                </aside>
                {% else %}
                <p>Clique no botao abaixo para gerar o QR Code PIX:</p>
                <form action="/filiacao/{{ ano }}/{{ token }}/gerar-pix" method="post">
                    <button type="submit">Gerar PIX</button>
                </form>
                {% endif %}
            </div>

            <!-- Conteudo Boleto -->
            <div id="tab-boleto" class="tab-content">
                {% if boleto %}
                <p>Seu boleto foi gerado com sucesso!</p>

                {% if boleto.barcode %}
                <div>
                    <label for="boleto-barcode">Codigo de barras:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="boleto-barcode" value="{{ boleto.barcode }}" readonly style="flex: 1; font-size: 0.85rem;">
                        <button type="button" onclick="copiarBoleto()" class="secondary" style="width: auto;">Copiar</button>
                    </div>
                </div>
                {% endif %}

                {% if boleto.boleto_link %}
                <p style="text-align: center; margin: 1.5rem 0;">
                    <a href="{{ boleto.boleto_link }}" target="_blank" role="button">Visualizar/Imprimir Boleto (PDF)</a>
                </p>
                {% endif %}

                <p><small>Vencimento: {{ boleto.due_date }}</small></p>

                <aside>
                    <p><strong>Prazo de compensacao</strong></p>
                    <p>O boleto pode levar ate 3 dias uteis para ser compensado apos o pagamento.</p>
                </aside>
                {% else %}
                <p>O boleto sera gerado com vencimento em 3 dias.</p>
                <form action="/filiacao/{{ ano }}/{{ token }}/gerar-boleto" method="post">
                    <button type="submit">Gerar Boleto</button>
                </form>
                {% endif %}
            </div>

            <!-- Conteudo Cartao -->
            <div id="tab-cartao" class="tab-content">
                <p>Pague com cartao de credito (parcela unica).</p>

                <form id="form-cartao" action="/filiacao/{{ ano }}/{{ token }}/pagar-cartao" method="post">
                    <label for="card-holder">Nome no cartao</label>
                    <input type="text" id="card-holder" name="holder_name" required placeholder="Como aparece no cartao">

                    <label for="card-number">Numero do cartao</label>
                    <input type="text" id="card-number" name="card_number" required placeholder="0000 0000 0000 0000" maxlength="19">

                    <div style="display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <label for="card-expiry">Validade</label>
                            <input type="text" id="card-expiry" name="card_expiry" required placeholder="MM/AA" maxlength="5">
                        </div>
                        <div style="flex: 1;">
                            <label for="card-cvv">CVV</label>
                            <input type="text" id="card-cvv" name="card_cvv" required placeholder="123" maxlength="4">
                        </div>
                    </div>

                    <input type="hidden" id="card-encrypted" name="card_encrypted">

                    <button type="submit" id="btn-pagar-cartao">Pagar {{ valor_formatado }}</button>
                </form>

                <aside>
                    <p><strong>Pagamento seguro</strong></p>
                    <p>Os dados do cartao sao criptografados e processados pelo PagBank. Nao armazenamos dados de cartao.</p>
                </aside>
            </div>
        </div>

        {% endif %}

        <p style="margin-top: 1.5rem;">Status atual: <mark>{{ pagamento.status }}</mark></p>
    </section>

    <footer>
        <a href="/filiacao/{{ ano }}/{{ token }}" role="button" class="secondary">Voltar e editar dados</a>
    </footer>
</article>

<script>
function showTab(tabName) {
    // Remove active de todos os labels e conteudos
    document.querySelectorAll('.tab-labels label').forEach(l => l.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    // Ativa o label clicado
    event.target.closest('label').classList.add('active');

    // Ativa o conteudo correspondente
    document.getElementById('tab-' + tabName).classList.add('active');
}

function copiarPix() {
    const input = document.getElementById('pix-code');
    input.select();
    navigator.clipboard.writeText(input.value);
    alert('Codigo PIX copiado!');
}

function copiarBoleto() {
    const input = document.getElementById('boleto-barcode');
    input.select();
    navigator.clipboard.writeText(input.value);
    alert('Codigo de barras copiado!');
}

// Formatar numero do cartao
document.getElementById('card-number')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
    e.target.value = value.substring(0, 19);
});

// Formatar validade
document.getElementById('card-expiry')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    e.target.value = value;
});

// Formatar CVV (apenas numeros)
document.getElementById('card-cvv')?.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
});
</script>

<!-- PagBank.js para criptografia de cartao -->
<script src="https://assets.pagseguro.com.br/checkout-sdk-js/rc/dist/browser/pagseguro.min.js"></script>
<script>
document.getElementById('form-cartao')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('btn-pagar-cartao');
    btn.disabled = true;
    btn.textContent = 'Processando...';

    try {
        const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
        const expiry = document.getElementById('card-expiry').value.split('/');
        const cvv = document.getElementById('card-cvv').value;
        const holder = document.getElementById('card-holder').value;

        // Criptografa o cartao com PagBank.js
        const card = PagSeguro.encryptCard({
            publicKey: "{{ pagbank_public_key or '' }}",
            holder: holder,
            number: cardNumber,
            expMonth: expiry[0],
            expYear: '20' + expiry[1],
            securityCode: cvv
        });

        if (card.hasErrors) {
            throw new Error('Dados do cartao invalidos: ' + JSON.stringify(card.errors));
        }

        document.getElementById('card-encrypted').value = card.encryptedCard;

        // Limpa dados sensiveis antes de enviar
        document.getElementById('card-number').value = '';
        document.getElementById('card-cvv').value = '';

        // Envia formulario
        this.submit();

    } catch (error) {
        alert('Erro ao processar cartao: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Pagar {{ valor_formatado }}';
    }
});
</script>
{% endblock %}
